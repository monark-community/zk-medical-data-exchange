@startuml Creation_Etude_Sequence
!theme plain

title Cura - Diagramme de Séquence : Création d'Étude

actor "Chercheur" as Researcher
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "studyController" as Controller
participant "studyService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "StudyFactory\n(Blockchain)" as Factory
participant "Study\n(Smart Contract)" as StudyContract

== Création de l'étude ==
Researcher -> Frontend : Créer une nouvelle étude
activate Frontend
Frontend -> Frontend : Valider les champs du formulaire
Researcher -> Frontend : Soumettre les informations

Frontend -> Backend : POST /studies/create {title, description, criteria, compensationAmount}
activate Backend

ref over Backend
    Authentification Backend
    verifySessionToken()
end ref

Backend -> Controller : createStudy(req, res)
activate Controller

Controller -> Controller : validateCriteria(eligibilityCriteria)
activate Controller
Controller -> Controller : Vérifier ranges, types, valeurs requises
deactivate Controller

alt Critères invalides
    Controller --> Backend : Erreur validation
    Backend --> Frontend : Critères invalides
    deactivate Backend
    Frontend --> Researcher : Erreur de validation
    deactivate Controller
    deactivate Frontend
else Critères valides
    Controller -->> Database : Enregistrer étude (status='draft') [async]
    activate Database
    Database -->> Controller : Étude créée avec ID
    deactivate Database
    
    Controller -->> Controller : auditService.logStudyCreation() [async]
    
    Controller --> Backend : Étude créée
    deactivate Controller
    Backend --> Frontend : Étude en brouillon
    deactivate Backend
    Frontend --> Researcher : Étude sauvegardée
    deactivate Frontend
end

== Déploiement sur la blockchain ==
Researcher -> Frontend : Déployer l'étude sur la blockchain
activate Frontend
Frontend -> Backend : POST /studies/:id/deploy
activate Backend

ref over Backend
    Authentification Backend
    verifySessionToken()
end ref

Backend -> Controller : deployStudy(req, res)
activate Controller

Controller -->> Database : Récupérer détails de l'étude [async]
activate Database
Database -->> Controller : Informations de l'étude
deactivate Database

Controller -> Service : deployStudy(studyParams)
activate Service

Service -> Service : formatCriteriaForContract(criteria)
activate Service
Service -> Service : Convertir en uint256[] pour Solidity
deactivate Service
Service -->> Factory : studyFactory.createStudy(criteriaArray, compensation) [async]
activate Factory
Factory -> StudyContract : Déployer nouveau contrat Study
activate StudyContract
StudyContract --> Factory : Study contract deployed
deactivate StudyContract
Factory -->> Service : StudyCreated event
deactivate Factory
Service --> Controller : {contractAddress, transactionHash}
deactivate Service

Controller -->> Database : Mettre à jour statut et adresse [async]
activate Database
Database -->> Controller : Étude mise à jour
deactivate Database

Controller --> Backend : {success: true, contractAddress}
deactivate Controller
Backend --> Frontend : 200 OK {contractAddress, transactionHash}
deactivate Backend
Frontend --> Researcher : Étude active sur la blockchain
deactivate Frontend

@enduml