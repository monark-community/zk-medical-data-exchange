@startuml Creation_Etude_Sequence
!theme plain

title Cura - Diagramme de Séquence : Création d'Étude

actor "Chercheur" as Researcher
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "studyController" as Controller
participant "studyService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "GovernanceFactory\n(Blockchain)" as Factory
participant "Study\n(Smart Contract)" as StudyContract

== Création de l'étude ==
Researcher -> Frontend : Créer une nouvelle étude
activate Frontend
Frontend -> Frontend : Valider les champs du formulaire
Researcher -> Frontend : Soumettre les informations

Frontend -> Backend : Créer l'étude (statut brouillon)
activate Backend

ref over Backend
    Validation de la session utilisateur
    (voir ref "Session Validation")
end ref

Backend -> Controller : createStudy(title, criteria, maxParticipants, ...)
activate Controller

Controller -> Controller : validateCriteria(eligibilityCriteria)

alt Critères invalides
    Controller --> Backend : Erreur validation
    Backend --> Frontend : Critères invalides
    deactivate Backend
    Frontend --> Researcher : Erreur de validation
    deactivate Controller
    deactivate Frontend
else Critères valides
    Controller -->> Database : Enregistrer l'étude (status='draft') [async]
    activate Database
    Database -->> Controller : Étude créée avec ID
    deactivate Database
    
    Controller -->> Controller : auditService.logStudyCreation() [async]
    
    Controller --> Backend : Étude créée
    deactivate Controller
    Backend --> Frontend : Étude en brouillon
    deactivate Backend
    Frontend --> Researcher : Étude sauvegardée
    deactivate Frontend
end

== Déploiement sur la blockchain ==
Researcher -> Frontend : Déployer l'étude sur la blockchain
activate Frontend
Frontend -> Backend : Déployer l'étude
activate Backend

ref over Backend
    Validation de la session utilisateur
    (voir ref "Session Validation")
end ref

Backend -> Controller : deployStudy(studyId)
activate Controller

Controller -->> Database : Récupérer les détails de l'étude [async]
activate Database
Database -->> Controller : Informations de l'étude
deactivate Database

Controller -> Service : deployStudy(studyParams)
activate Service

Service -> Service : formatCriteriaForContract(criteria)
Service -->> Factory : createStudy(title, criteria, zkVerifier) [async]
activate Factory
Factory -> StudyContract : Déployer nouveau contrat Study
activate StudyContract
StudyContract --> Factory : Adresse du contrat
deactivate StudyContract
Factory -->> Service : StudyCreated event + adresse
deactivate Factory
Service --> Controller : Déploiement réussi
deactivate Service

Controller -->> Database : Mettre à jour (status='active', contract_address) [async]
activate Database
Database -->> Controller : Étude mise à jour
deactivate Database

Controller --> Backend : Déploiement confirmé
deactivate Controller
Backend --> Frontend : Étude déployée
deactivate Backend
Frontend --> Researcher : Étude active sur la blockchain
deactivate Frontend

@enduml