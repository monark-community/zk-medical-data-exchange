@startuml Governance_Proposal_Creation_Sequence
!theme plain

title Cura - Diagramme de Séquence : Création de Proposition de Gouvernance

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "governanceController" as Controller
participant "governanceService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "Blockchain\n(Sepolia)" as Blockchain
participant "GovernanceFactory\n(Smart Contract)" as Factory
participant "Proposal\n(Smart Contract)" as ProposalContract

== Phase de Saisie ==
User -> Frontend : Accéder à la page gouvernance
activate Frontend
ref over Frontend : Vérifier session utilisateur
User -> Frontend : Cliquer sur "Créer proposition"
User -> Frontend : Remplir le formulaire
Frontend -> Frontend : Valider les champs saisis
activate Frontend
deactivate Frontend
User -> Frontend : Soumettre la proposition

== Phase de Création ==
Frontend -> Backend : Envoyer la proposition
activate Backend
Backend -> Controller : Créer la proposition
activate Controller

Controller -> Controller : Valider les données
activate Controller
deactivate Controller

Controller -> Service : Lancer la création
activate Service

Service -->> Blockchain : Soumettre sur la blockchain (async)
activate Blockchain
Blockchain -> Factory : Créer la proposition
activate Factory

Factory -> ProposalContract : Déployer le contrat
activate ProposalContract
ProposalContract --> Factory : Adresse du contrat
deactivate ProposalContract

Factory -> Factory : Enregistrer dans le registre
activate Factory
deactivate Factory

Factory -->> Blockchain : Émettre événement ProposalCreated
deactivate Factory

Blockchain -->> Service : Reçu de transaction
deactivate Blockchain

Service -->> ProposalContract : Récupérer les détails (async)
activate ProposalContract
ProposalContract -->> Service : Détails de la proposition
deactivate ProposalContract

Service -->> Database : Sauvegarder en base de données (async)
activate Database
Database -->> Service : Proposition enregistrée
deactivate Database

Service --> Controller : Proposition créée avec succès
deactivate Service

Controller -->> Service : Enregistrer dans l'audit (async)
activate Service
deactivate Service

Controller --> Backend : Création réussie
deactivate Controller

Backend --> Frontend : Proposition créée
deactivate Backend

Frontend -> User : Afficher la proposition
deactivate Frontend

== Gestion d'Erreurs ==
alt Données invalides
    Controller -> Controller : Valider les données
    activate Controller
    Controller --> Backend : Validation échouée
    deactivate Controller
    Backend --> Frontend : Données incorrectes
    Frontend -> User : Afficher les erreurs du formulaire
else Erreur blockchain
    Service -->> Blockchain : Soumettre sur la blockchain (async)
    activate Service
    activate Blockchain
    Blockchain -->> Service : Erreur de transaction
    deactivate Blockchain
    Service --> Controller : Échec de la création
    deactivate Service
    Controller --> Backend : Erreur serveur
    Backend --> Frontend : Transaction échouée
    Frontend -> User : Afficher l'erreur
end

@enduml