@startuml Governance_Proposal_Creation_Sequence
!theme plain

title Cura - Diagramme de Séquence : Création de Proposition de Gouvernance

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "governanceController" as Controller
participant "governanceService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "GovernanceFactory\n(Blockchain)" as Factory
participant "Proposal\n(Smart Contract)" as ProposalContract

== Phase de Saisie ==
User -> Frontend : Accéder à la page gouvernance
activate Frontend
ref over Frontend
    Vérification session locale
    hasSessionTokens()
end ref
User -> Frontend : Cliquer sur "Créer proposition"
User -> Frontend : Remplir le formulaire
Frontend -> Frontend : Valider les champs saisis
activate Frontend
deactivate Frontend
User -> Frontend : Soumettre la proposition

== Phase de Création ==
Frontend -> Backend : Envoyer la proposition
activate Backend
Backend -> Controller : Créer la proposition
activate Controller

Controller -> Controller : Valider les données
activate Controller
deactivate Controller

Controller -> Service : Lancer la création
activate Service

Service -->> Factory : createProposal(title, description, votingPeriod) [async]
activate Factory

Factory -> ProposalContract : new Proposal(params)
activate ProposalContract
ProposalContract -> ProposalContract : Initialiser votes (for: 0, against: 0)
ProposalContract --> Factory : deployedAddress
deactivate ProposalContract

Factory -> Factory : proposals.push(proposalAddress)
activate Factory
Factory -> Factory : emit ProposalCreated(id, creator, address)
deactivate Factory

Factory -->> Service : {proposalId, contractAddress, txHash}
deactivate Factory

Service -->> ProposalContract : Récupérer les détails (async)
activate ProposalContract
ProposalContract -->> Service : Détails de la proposition
deactivate ProposalContract

Service -->> Database : Sauvegarder en base de données (async)
activate Database
Database -->> Service : Proposition enregistrée
deactivate Database

Service --> Controller : Proposition créée avec succès
deactivate Service

Controller -->> Service : Enregistrer dans l'audit (async)
activate Service
deactivate Service

Controller --> Backend : Création réussie
deactivate Controller

Backend --> Frontend : Proposition créée
deactivate Backend

Frontend -> User : Afficher la proposition
deactivate Frontend

@enduml