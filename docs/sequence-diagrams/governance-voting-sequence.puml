@startuml Governance_Voting_Sequence
!theme plain

title Cura - Diagramme de Séquence : Vote sur Proposition de Gouvernance

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "governanceController" as Controller
participant "governanceService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "Blockchain\n(Sepolia)" as Blockchain
participant "Proposal\n(Smart Contract)" as ProposalContract

== Phase de Consultation ==
User -> Frontend : Accéder à la gouvernance
activate Frontend
ref over Frontend : Vérifier session utilisateur
Frontend -> Backend : Récupérer les propositions
activate Backend
Backend -> Controller : getAllProposals(userAddress)
activate Controller
Controller -> Service : getAllProposals(userAddress)
activate Service
Service -->> Database : Lire propositions actives (async)
activate Database
Database -->> Service : Liste des propositions
deactivate Database
Service --> Controller : Propositions avec votes
deactivate Service
Controller --> Backend : Données des propositions
deactivate Controller
Backend --> Frontend : Liste des propositions
deactivate Backend
Frontend -> User : Afficher les propositions
deactivate Frontend

== Phase de Sélection ==
User -> Frontend : Sélectionner une proposition
activate Frontend
Frontend -> Backend : Obtenir détails de la proposition
activate Backend
Backend -> Controller : getProposal(proposalId, userAddress)
activate Controller
Controller -> Service : getProposal(proposalId, userAddress)
activate Service
Service -->> Database : Lire détails proposition (async)
activate Database
Database -->> Service : Données complètes
deactivate Database
Service --> Controller : Détails + statut vote utilisateur
deactivate Service
Controller --> Backend : Proposition détaillée
deactivate Controller
Backend --> Frontend : Détails avec boutons vote
deactivate Backend
Frontend -> User : Afficher proposition complète
deactivate Frontend

== Phase de Vote ==
User -> Frontend : Choisir Pour ou Contre
activate Frontend
Frontend -> Backend : Soumettre le vote
activate Backend
Backend -> Controller : vote(proposalId, choice, walletAddress)
activate Controller

Controller -> Controller : Valider le vote
activate Controller
deactivate Controller

Controller -> Service : Enregistrer le vote
activate Service

Service -->> Database : Vérifier si déjà voté (async)
activate Database
Database -->> Service : Résultat de vérification
deactivate Database

alt Déjà voté
    Service --> Controller : Vote déjà enregistré
    deactivate Service
    Controller --> Backend : Erreur double vote
    deactivate Controller
    Backend --> Frontend : Vote refusé
    deactivate Backend
    Frontend -> User : Afficher erreur
    deactivate Frontend
else Vote autorisé
    Service -> Service : Récupérer le contrat
    activate Service
    deactivate Service
    
    Service -->> Blockchain : Soumettre le vote (async)
    activate Blockchain
    Blockchain -> ProposalContract : Enregistrer le vote
    activate ProposalContract
    ProposalContract --> Blockchain : Vote enregistré
    deactivate ProposalContract
    Blockchain -->> Service : Confirmation transaction
    deactivate Blockchain
    
    Service -->> ProposalContract : Obtenir résultats actuels (async)
    activate ProposalContract
    ProposalContract -->> Service : Compteurs de votes
    deactivate ProposalContract
    
    Service -->> Database : Mettre à jour les compteurs (async)
    activate Database
    Database -->> Service : Compteurs mis à jour
    deactivate Database
    
    Service -->> Database : Sauvegarder le vote (async)
    activate Database
    Database -->> Service : Vote sauvegardé
    deactivate Database
    
    Service --> Controller : Vote réussi
    deactivate Service
    
    Controller -->> Service : Enregistrer dans l'audit (async)
    activate Service
    deactivate Service
    
    Controller --> Backend : Vote confirmé
    deactivate Controller
    Backend --> Frontend : Succès
    deactivate Backend
    Frontend -> User : Afficher confirmation
    deactivate Frontend
end

== Gestion d'Erreurs ==
alt Données invalides
    Controller -> Controller : Valider le vote
    activate Controller
    Controller --> Backend : Vote invalide
    deactivate Controller
    Backend --> Frontend : Validation échouée
    Frontend -> User : Afficher erreur
else Erreur blockchain
    Service -->> Blockchain : Soumettre le vote (async)
    activate Service
    activate Blockchain
    Blockchain -->> Service : Erreur de transaction
    deactivate Blockchain
    Service --> Controller : Échec de l'enregistrement
    deactivate Service
    Controller --> Backend : Erreur serveur
    Backend --> Frontend : Transaction échouée
    Frontend -> User : Afficher l'erreur
end

@enduml