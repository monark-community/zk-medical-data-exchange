@startuml Consent_Revocation_Sequence
!theme plain

title Cura - Diagramme de Séquence : Révocation de Consentement d'Étude

actor "Patient" as Patient
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "studyController" as Controller
participant "studyService" as Service
participant "Base de Données\n(Supabase)" as Database
participant "StudyContract\n(Blockchain)" as StudyContract

== Consultation des participations ==
Patient -> Frontend : Accéder à "Mes Études"
activate Frontend
ref over Frontend
    Vérification session locale
    hasSessionTokens()
end ref
Frontend -> Backend : GET /studies/enrolled
activate Backend
Backend -->> Database : Rechercher participations actives (async)
activate Database
Database -->> Backend : Liste des études avec statuts
deactivate Database
Backend --> Frontend : Études participées
deactivate Backend
Frontend --> Patient : Affiche les études avec option révocation
deactivate Frontend

== Sélection et confirmation ==
Patient -> Frontend : Sélectionner une étude et cliquer "Révoquer"
activate Frontend
Frontend --> Patient : Afficher modal de confirmation
Patient -> Frontend : Confirmer la révocation

== Révocation du consentement ==
Frontend -> Backend : POST /studies/:id/consent/revoke
activate Backend

ref over Backend
    Authentification Backend
    verifySessionToken()
end ref

Backend -> Controller : revokeStudyConsent(req, res)
activate Controller

Controller -->> Database : Vérifier participation existante (async)
activate Database
Database -->> Controller : Participation trouvée
deactivate Database

Controller -> Controller : canPerformConsentOperation()

alt Consentement déjà révoqué
    Controller --> Backend : Erreur : déjà révoqué
    Backend --> Frontend : Consentement déjà révoqué
    deactivate Backend
    Frontend --> Patient : Afficher erreur
    deactivate Controller
    deactivate Frontend
else Consentement actif
    Controller -> Service : studyService.revokeStudyConsent(studyId, walletAddress)
    activate Service
    Service -->> StudyContract : studyContract.revokeConsent(userAddress) [async]
    activate StudyContract
    StudyContract -> StudyContract : Vérifier participant actif
    StudyContract -> StudyContract : Émettre ConsentRevoked event
    StudyContract -->> Service : {transactionHash, blockNumber}
    deactivate StudyContract
    Service --> Controller : {transactionHash, gasUsed}
    deactivate Service
    
    Controller -->> Database : Mettre à jour statut consentement [async]
    activate Database
    Database -->> Controller : Statut mis à jour
    deactivate Database
    
    Controller -->> Database : Décrémenter compteur participants [async]
    activate Database
    Database -->> Controller : Compteur mis à jour
    deactivate Database
    
    Controller -->> Controller : auditService.logConsentRevocation() [async]
    
    Controller --> Backend : Révocation réussie
    deactivate Controller
    Backend --> Frontend : Consentement révoqué
    deactivate Backend
    Frontend --> Patient : Révocation confirmée
    deactivate Frontend
end

@enduml