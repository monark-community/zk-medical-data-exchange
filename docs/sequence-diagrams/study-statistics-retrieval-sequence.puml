@startuml Study_Statistics_Retrieval_Sequence
!theme plain

title Cura - Diagramme de Séquence : Récupération des Études et Statistiques

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "API Backend\n(Express)" as Backend
participant "studyController" as Controller
participant "Base de Données\n(Supabase)" as Database

== Récupération des études ==
User -> Frontend : Consulter les études disponibles
activate Frontend

ref over Frontend
    Vérification session utilisateur
    (voir ref "Session Validation")
end ref

Frontend -> Backend : Récupérer la liste des études
activate Backend
Backend -> Controller : getStudies(status, createdBy, page, limit)
activate Controller

Controller -->> Database : Rechercher les études avec filtres [async]
activate Database
Database -->> Controller : Liste des études
deactivate Database

loop Pour chaque étude
    Controller -->> Database : Calculer le nombre de participants actifs [async]
    activate Database
    Database -->> Controller : Nombre de participants
    deactivate Database
end

Controller -> Controller : transformStudyForResponse(studies)

Controller --> Backend : Études avec statistiques
deactivate Controller
Backend --> Frontend : Liste des études
deactivate Backend
Frontend --> User : Affiche les études avec leurs statistiques
deactivate Frontend

== Consultation des détails d'une étude ==
User -> Frontend : Sélectionner une étude spécifique
activate Frontend
Frontend -> Backend : Récupérer les détails de l'étude
activate Backend
Backend -> Controller : getStudyById(studyId)
activate Controller

Controller -->> Database : Rechercher l'étude par ID [async]
activate Database
Database -->> Controller : Détails de l'étude
deactivate Database

Controller -->> Database : Compter les participants actifs [async]
activate Database
Database -->> Controller : Statistiques de participation
deactivate Database

Controller --> Backend : Détails complets avec statistiques
deactivate Controller
Backend --> Frontend : Informations détaillées
deactivate Backend
Frontend --> User : Affiche les détails de l'étude
deactivate Frontend

@enduml