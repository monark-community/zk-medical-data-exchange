@startuml Medical_Data_Upload_Sequence
!theme plain

title Cura - Diagramme de Séquence : Téléversement de Données Médicales FHIR

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "UploadSection\n(Component)" as UploadComponent
participant "Pinata\n(IPFS)" as IPFS
participant "API Backend\n(Express)" as Backend
participant "medicalDataController" as Controller
participant "Base de Données\n(Supabase)" as Database

== Phase de Sélection ==
User -> Frontend : Accéder aux données médicales
activate Frontend
ref over Frontend : Vérifier session utilisateur
User -> UploadComponent : Cliquer sur "Upload Medical Data"
activate UploadComponent
UploadComponent -> User : Ouvrir sélecteur de fichiers
deactivate UploadComponent
User -> UploadComponent : Sélectionner fichier JSON
activate UploadComponent

== Phase de Validation FHIR ==
UploadComponent -> UploadComponent : Lire le fichier
activate UploadComponent
deactivate UploadComponent
UploadComponent -> UploadComponent : Vérifier la conformité FHIR
activate UploadComponent
deactivate UploadComponent

alt Fichier conforme
    UploadComponent -> UploadComponent : Marquer comme valide
    activate UploadComponent
    deactivate UploadComponent
    UploadComponent -> User : Afficher "FHIR Compliant"
    deactivate UploadComponent
else Fichier non conforme
    UploadComponent -> UploadComponent : Marquer comme invalide
    activate UploadComponent
    deactivate UploadComponent
    UploadComponent -> User : Afficher "Not Compliant"
    deactivate UploadComponent
end

== Phase de Chiffrement et Téléversement ==
User -> UploadComponent : Confirmer l'envoi
activate UploadComponent
UploadComponent -> UploadComponent : Lire le contenu
activate UploadComponent
deactivate UploadComponent
UploadComponent -> UploadComponent : Chiffrer les données
activate UploadComponent
deactivate UploadComponent

UploadComponent -->> IPFS : Téléverser sur IPFS (async)
activate IPFS
IPFS -->> UploadComponent : Identifiant du fichier
deactivate IPFS

UploadComponent -> UploadComponent : Chiffrer l'identifiant
activate UploadComponent
deactivate UploadComponent

UploadComponent -> Backend : Enregistrer les métadonnées
activate Backend
Backend -> Controller : Traiter la requête
activate Controller

Controller -->> Database : Sauvegarder dans la base (async)
activate Database
Database -->> Controller : Enregistrement réussi
deactivate Database

Controller -->> Controller : Enregistrer dans l'audit (async)
activate Controller
deactivate Controller

Controller --> Backend : Données enregistrées
deactivate Controller

Backend --> UploadComponent : Succès
deactivate Backend

UploadComponent -> UploadComponent : Notifier le système
activate UploadComponent
deactivate UploadComponent

UploadComponent -> User : Afficher confirmation
deactivate UploadComponent
deactivate Frontend

== Gestion d'Erreurs ==
alt Validation échouée
    UploadComponent -> UploadComponent : Vérifier la conformité
    activate UploadComponent
    UploadComponent -> UploadComponent : Bloquer l'envoi
    deactivate UploadComponent
    UploadComponent -> User : Fichier non conforme
else Erreur téléversement IPFS
    UploadComponent -->> IPFS : Téléverser sur IPFS (async)
    activate UploadComponent
    activate IPFS
    IPFS -->> UploadComponent : Erreur de stockage
    deactivate IPFS
    UploadComponent -> User : Échec du téléversement
    deactivate UploadComponent
else Erreur sauvegarde
    Controller -->> Database : Sauvegarder dans la base (async)
    activate Controller
    activate Database
    Database -->> Controller : Erreur d'enregistrement
    deactivate Database
    Controller --> Backend : Erreur serveur
    deactivate Controller
    Backend --> UploadComponent : Sauvegarde échouée
    UploadComponent -> User : Afficher l'erreur
end

@enduml