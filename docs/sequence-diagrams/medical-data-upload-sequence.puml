@startuml Medical_Data_Upload_Sequence
!theme plain

title Cura - Diagramme de Séquence : Téléversement de Données Médicales FHIR

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "UploadSection\n(Component)" as UploadComponent
participant "Pinata\n(IPFS)" as IPFS
participant "API Backend\n(Express)" as Backend
participant "medicalDataController" as Controller
participant "Base de Données\n(Supabase)" as Database

== Phase de Sélection ==
User -> Frontend : Accéder aux données médicales
activate Frontend
ref over Frontend
    Vérification session locale
    hasSessionTokens()
end ref
User -> UploadComponent : handleUploadMedicalData()
activate UploadComponent
UploadComponent -> User : input.click() - Sélecteur de fichiers
deactivate UploadComponent
User -> UploadComponent : Sélectionner fichier JSON
activate UploadComponent

== Phase de Validation FHIR ==
UploadComponent -> UploadComponent : file = input.files[0]
activate UploadComponent
deactivate UploadComponent
UploadComponent -> UploadComponent : checkCompliance(file)
activate UploadComponent
deactivate UploadComponent

alt Fichier conforme (reportType valide)
    UploadComponent -> UploadComponent : Marquer comme valide
    activate UploadComponent
    deactivate UploadComponent
    UploadComponent -> User : Afficher "FHIR Compliant"
    deactivate UploadComponent
else Fichier non conforme
    UploadComponent -> UploadComponent : setIsCompliant(false), setReadyToSend(false)
    activate UploadComponent
    deactivate UploadComponent
    UploadComponent -> User : Afficher "Not Compliant"
    deactivate UploadComponent
end

== Phase de Chiffrement et Téléversement ==
User -> UploadComponent : Cliquer "Confirm & Send"
activate UploadComponent
UploadComponent -> UploadComponent : fileReader.readAsText(file)
activate UploadComponent
UploadComponent -> UploadComponent : JSON.parse(fileContent)
deactivate UploadComponent
UploadComponent -> UploadComponent : encryptWithAES(jsonData, aesKey)
activate UploadComponent
UploadComponent -> UploadComponent : Générer buffer chiffré
deactivate UploadComponent

UploadComponent -->> IPFS : pinata.upload(encryptedBuffer) [async]
activate IPFS
IPFS -->> UploadComponent : {IpfsHash: cid, PinSize, Timestamp}
deactivate IPFS

UploadComponent -> UploadComponent : encryptCID(cid, userAesKey)
activate UploadComponent
deactivate UploadComponent

UploadComponent -> Backend : uploadMedicalData({encryptedCid, fileType, reportType})
activate Backend
Backend -> Controller : POST /medical-data/upload
activate Controller

Controller -->> Database : INSERT INTO medical_data (user_id, encrypted_cid, file_type, report_type) [async]
activate Database
Database -->> Controller : {id, created_at}
deactivate Database

Controller -->> Controller : auditService.logMedicalDataUpload() [async]
activate Controller
deactivate Controller

Controller --> Backend : {success: true}
deactivate Controller

Backend --> UploadComponent : 200 OK
deactivate Backend

UploadComponent -> UploadComponent : eventBus.emit('medicalDataUploaded')
activate UploadComponent
deactivate UploadComponent

UploadComponent -> User : useTxStatusState.show("Medical data uploaded successfully")
deactivate UploadComponent
deactivate Frontend

@enduml