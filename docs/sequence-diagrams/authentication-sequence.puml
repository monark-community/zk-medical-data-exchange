@startuml Authentication_Sequence
!theme plain

title Cura - Diagramme de Séquence : Authentification Web3Auth

actor "Utilisateur" as User
participant "Interface Web\n(Next.js)" as Frontend
participant "Web3Auth Modal" as Web3Auth
participant "AuthJS JWKS\n(Web3Auth)" as AuthJS
participant "API Backend\n(Express)" as Backend
participant "web3AuthMiddleware" as Middleware
participant "authController" as AuthController
participant "userService" as UserService
participant "Base de Données\n(Supabase)" as Database

== Phase d'Initialisation ==
User -> Frontend : Accéder à l'application
activate Frontend
Frontend -> Frontend : Vérifier session existante
activate Frontend
deactivate Frontend

alt Aucune session active
    Frontend -->> Web3Auth : Demander connexion (async)
    activate Web3Auth
    Web3Auth -->> Frontend : Connexion établie
    deactivate Web3Auth
    
    Frontend -->> Web3Auth : Récupérer jeton d'identité (async)
    activate Web3Auth
    Web3Auth -->> Frontend : Jeton JWT
    deactivate Web3Auth
end

== Phase de Vérification Backend ==
Frontend -> Backend : Envoyer jeton pour vérification
activate Backend
Backend -> Middleware : Vérifier jeton Web3Auth
activate Middleware

Middleware -->> AuthJS : Obtenir clé de signature (async)
activate AuthJS
AuthJS -->> Middleware : Clé publique
deactivate AuthJS

Middleware -> Middleware : Valider jeton JWT
activate Middleware
deactivate Middleware

alt Jeton valide
    Middleware -> AuthController : Continuer
    deactivate Middleware
    
    activate AuthController
    AuthController -> UserService : Vérifier existence utilisateur
    activate UserService
    UserService -->> Database : Rechercher utilisateur (async)
    activate Database
    Database -->> UserService : Résultat
    deactivate Database
    UserService --> AuthController : Utilisateur existant
    deactivate UserService
    
    alt Nouvel utilisateur
        AuthController -> UserService : Créer utilisateur
        activate UserService
        UserService -->> Database : Insérer nouvel utilisateur (async)
        activate Database
        Database -->> UserService : Utilisateur créé
        deactivate Database
        UserService --> AuthController : Confirmation
        deactivate UserService
    end
    
    AuthController -> AuthController : Générer jeton de session
    activate AuthController
    deactivate AuthController
    
    AuthController --> Backend : Jeton de session
    deactivate AuthController
    
    Backend --> Frontend : Authentification réussie
    deactivate Backend
    
    Frontend -> Frontend : Enregistrer session
    activate Frontend
    deactivate Frontend
    
    Frontend -> User : Rediriger vers tableau de bord
    deactivate Frontend
    
else Jeton invalide ou expiré
    Middleware --> Backend : Échec validation
    deactivate Middleware
    Backend --> Frontend : Non autorisé
    deactivate Backend
    
    Frontend -> User : Afficher erreur
    deactivate Frontend
end

== Phase de Validation Continue ==
loop Requêtes authentifiées
    Frontend -> Backend : Requête avec jeton de session
    activate Backend
    ref over Backend : Valider jeton de session
    
    alt Jeton valide
        Backend --> Frontend : Données demandées
        deactivate Backend
    else Jeton expiré ou invalide
        Backend --> Frontend : Session expirée
        deactivate Backend
        Frontend -> User : Retour à l'accueil
    end
end

== Phase de Déconnexion ==
User -> Frontend : Cliquer sur déconnexion
activate Frontend
Frontend -->> Web3Auth : Déconnecter le portefeuille (async)
activate Web3Auth
deactivate Web3Auth
Frontend -> Frontend : Supprimer session locale
activate Frontend
deactivate Frontend
Frontend -> User : Retour à la page d'accueil
deactivate Frontend

@enduml
