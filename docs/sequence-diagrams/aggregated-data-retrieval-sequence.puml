@startuml
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontSize 12

actor Researcher
participant "Web UI" as UI
participant "Frontend Service" as Service
participant "API Server" as API
participant "Blockchain\n(Study Contract)" as BC
database "Supabase" as DB

title Data Aggregation - Researcher Views Study Results

== Study Completion ==
Researcher -> UI: End Study
UI -> API: PATCH /studies/:id\n{status: "completed"}
API -> DB: Update study status
API --> UI: Success

== View Aggregated Results ==
Researcher -> UI: Click "Show Results"
UI -> Service: getAggregatedData(studyId, wallet)
Service -> API: GET /studies/:id/aggregated-data\n?creatorWallet=0x...

API -> DB: Verify study status\nVerify creator authorization
DB --> API: Study metadata

alt Study not completed or unauthorized
    API --> Service: Error 400/403
    Service --> UI: Show error message
else Study ready
    API -> BC: getBins()
    BC --> API: Bin configuration
    
    API -> BC: getAllBinCounts()
    BC --> API: Participant counts per bin
    
    API -> BC: getParticipantCount()
    BC --> API: Total active participants
    
    API -> API: Transform data
    API --> Service: Aggregated data
    
    Service -> Service: Process bins\nGroup by field\nCalculate percentages
    Service --> UI: Processed data
    
    UI -> UI: Render visualizations
    UI --> Researcher: Display beautiful charts\nwith bin distributions
end

== Export Results ==
Researcher -> UI: Click "Download CSV"
UI -> UI: Generate CSV from data
UI --> Researcher: Download file

note right of BC
  **Privacy Preserved**
  - Only counts per bin
  - No individual data
  - Zero-knowledge proofs
  - Encrypted commitments
end note

note right of UI
  **Visualization Features**
  - Summary cards
  - Horizontal bar charts
  - Percentage labels
  - Color-coded bins
  - Privacy notice
end note

@enduml
